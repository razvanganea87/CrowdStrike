from typing import List, Dict
from datetime import datetime

from models.zafran_vulnerability import ZafranVulnerability
from models.component import Component, ComponentType
from models.remediation import Remediation
from models.cvss import CVSS
from models.zafran_asset import ZafranAsset


class VulnerabilityMapper:

    @staticmethod
    def map(raw_vulnerabilities: List[dict], assets: List[ZafranAsset]) -> List[ZafranVulnerability]:
        vulnerabilities = []

        asset_index: Dict[str, ZafranAsset] = {
            asset.instance_id: asset for asset in assets
        }

        for raw in raw_vulnerabilities:
            aid = raw.get("aid")
            asset = asset_index.get(aid)
            instance_id = asset.instance_id if asset else None

            cve = raw.get("cve")

            component = None
            apps = raw.get("apps", [])
            if apps:
                app = apps[0]
                component = Component(
                    type=ComponentType.APPLICATION,
                    product=app.get("product_name"),
                    vendor=app.get("vendor"),
                    version=app.get("version"),
                    display_name=app.get("product_name")
                )

            remediation_data = raw.get("remediation", {})
            remediation = Remediation(
                suggestion=remediation_data.get("recommendation"),
                source="CrowdStrike",
                fixed_in_version=remediation_data.get("fixed_in_version")
            )

            cvss_list = []
            cvss_data = raw.get("cvss")
            if cvss_data:
                cvss_list.append(
                    CVSS(
                        version="3.x",
                        vector=cvss_data.get("vector"),
                        base_score=cvss_data.get("base_score"),
                        source="CrowdStrike",
                        type="primary"
                    )
                )

            first_observed = VulnerabilityMapper._parse_timestamp(
                raw.get("created_timestamp")
            )
            last_observed = VulnerabilityMapper._parse_timestamp(
                raw.get("updated_timestamp")
            )

            vulnerability = ZafranVulnerability(
                instance_id=instance_id,
                cve=cve,
                in_runtime=True,
                component=component,
                remediation=remediation,
                cvss_list=cvss_list,
                cwe_ids=[],
                description=raw.get("description"),
                first_observed=first_observed,
                last_observed=last_observed,
                file_paths=[],
                scanner_id=raw.get("id"),
                external_url=None,
                references_url=None,
                scanner_name="CrowdStrike Spotlight",
                severity=raw.get("severity")
            )

            vulnerabilities.append(vulnerability)

        return vulnerabilities

    @staticmethod
    def _parse_timestamp(value: str):
        if not value:
            return None
        return datetime.fromisoformat(value.replace("Z", "+00:00"))
